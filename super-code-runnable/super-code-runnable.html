<!-- <link rel="import" href="../launch-icon.svg"> -->
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">

<dom-module id='super-code-runnable'>
  <template>

    <style>
      :host {
        display: flex;
      }
      .panel {
        overflow: scroll;
        flex: 1;
        transition: flex-grow 300ms;
        position: relative;
      }
      #codePanel {
      }
      #runButton {
        position: absolute;
        bottom: 10px;
        right: 10px;
      }
      #displayPanel {
        width: 0;
        flex: 0.00000001;
        border: 0;
        min-height: 100%;
        background-color: white;
      }

      :host(.activated) #runButton {
        display: none;
      }
      :host(.activated) .panel {
      }
      :host(.activated) #displayPanel {
        flex: 1;
      }
       </style>

    <!--
      1. Hold either a SUPER-CODE or SUPER-CODE-GROUP element

      2. Present a big RUN button

      3. On press, open-right a frame:
        - √ If SUPER-CODE & HTML: Display contents
        - √ IF SUPER-CODE & JS: Run, Display Output
        - IF SUPER-CODE & RUN-URL: Make ajax to run, Display response
        - IF SUPER-CODE-GROUP & IS-RUNNABLE (HTML, JS, & CSS ONLY): Display and Run all

      4. Respect attributes
        - sandbox: runs JS in a sandbox, defaults true
        -

    -->

    <div id="codePanel" class="panel">
      <content id="superCodeElement" select="super-code"></content>
      <paper-fab id="runButton" src="play-icon.svg" title="heart eyes cat"></paper-fab>
    </div>

  </template>

  <script>
    // I needed the opposite function today, so adding here too:
    function htmlEncode(value){
        return String(value)
            .replace(/&quot;/g, '"')
            .replace(/&#39;/g, "'")
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&amp;/g, '&');
    }

  Polymer({
    is: 'super-code-runnable',
    properties: {},

    created: function() {
      console.log(this.localName + '#' + this.id + ' was created');
    },

    ready: function() {
      console.log(this.localName + '#' + this.id + ' has local DOM initialized');
    },

    attached: function() {
      console.log(this.localName + '#' + this.id + ' was attached');
    },

    detached: function() {
      console.log(this.localName + '#' + this.id + ' was detached');
    },

    attributeChanged: function(name, type) {
      console.log(this.localName + '#' + this.id + ' attribute ' + name +
        ' was changed to ' + this.getAttribute(name));
    },

    listeners: {
      'runButton.tap': 'specialTap'
    },

    generateJSOutput: function() {
      let _log = console.log;
      let _warn = console.warn;
      let _error = console.error;
      let styleSetup = "<style>body {font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace; line-height: 1.5em; white-space: nowrap; font-size: 0.8em;}</style>";
      let codeOutput = '';
      let codeResult;
      let codeToEval = Polymer.dom(this.$.superCodeElement).getDistributedNodes()[0].innerHTML;

      console.log = function() {
        var args = Array.prototype.slice.call(arguments);
        codeOutput += args.join(' ') + '</br>';
      };
      console.warn = function() {
        var args = Array.prototype.slice.call(arguments);
        codeOutput += '<span style="color: orange;">[warn] ' + args.join(' ') + '</span></br>';
      };
      console.error = function() {
        var args = Array.prototype.slice.call(arguments);
        codeOutput += '<span style="color: red;">[error] ' + args.join(' ') + '</span></br>';
      };
      codeResult = eval(codeToEval);
      console.log = _log;
      console.warn = _warn;
      console.error = _error;

      let iframe = document.createElement('iframe');
      iframe.id = 'displayPanel';
      iframe.className = 'panel';
      let html = styleSetup + codeOutput + '<span style="opacity: 0.4;"><span style="font-size: .7em; font-weight: bold;">></span> ' + codeResult + '</span>';
      this.root.appendChild(iframe);

      iframe.contentWindow.document.open();
      iframe.contentWindow.document.write(html);
      iframe.contentWindow.document.close();

      setTimeout(() => {
        iframe.contentWindow.scrollTo( 0, 999999 );
      }, 1);
    },

    generateHTMLOutput: function() {
      let codeElement = Polymer.dom(this.$.superCodeElement).getDistributedNodes()[0];
      let htmlToDisplay = codeElement.innerHTML || htmlEncode(codeElement.getAttribute('code'));

      let iframe = document.createElement('iframe');
      iframe.id = 'displayPanel';
      iframe.className = 'panel';
      iframe.height = this.clientHeight;
      this.root.appendChild(iframe);

      iframe.contentWindow.document.open();
      iframe.contentWindow.document.write(htmlToDisplay);
      iframe.contentWindow.document.close();
    },

    specialTap: function(e) {
      let language = Polymer.dom(this.$.superCodeElement).getDistributedNodes()[0].getAttribute('language');
      if (language === "js" || language === "javascript") {
        this.generateJSOutput();
      } else if (language === "html") {
        this.generateHTMLOutput();
      }

      setTimeout(() => {
        this.toggleClass('activated', true);
      }, 0);
    },

  });
  </script>
</dom-module>
