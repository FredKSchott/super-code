<!-- <link rel="import" href="../launch-icon.svg"> -->
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">

<dom-module id='super-code-runnable'>
  <template>

    <style>
      :host {
        display: flex;
      }
      .panel {
        overflow: scroll;
        flex: 1;
        transition: flex-grow 300ms;
        position: relative;
      }
      #runButton {
        position: absolute;
        bottom: 10px;
        right: 10px;
      }

      #displayPanel {
        width: 0;
        flex: 0.00000001;
        border: 0;
        min-height: 100%;
        background-color: white;
        box-shadow: -10px 0px 10px 0px rgba(0,0,0,0.19);
        box-sizing: border-box;
      }

      #displayPanel.console {
        font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
        line-height: 1.5em;
        white-space: nowrap;
        padding: 10px;
        background-color: #FFF;
      }

      #displayPanel.console .console-output.level-warn {
        color: #DD8811;
      }

      #displayPanel.console .console-output.level-error {
        color: #C11;
      }

      #displayPanel.console .console-result {
        opacity: 0.5;
      }

      :host(.activated) #runButton {
        display: none;
      }
      :host(.activated) .panel {
      }
      :host(.activated) #displayPanel {
        flex: 1;
      }
       </style>

    <!--
      1. Hold either a SUPER-CODE or SUPER-CODE-GROUP element

      2. Present a big RUN button

      3. On press, open-right a frame:
        - √ If SUPER-CODE & HTML: Display contents
        - √ IF SUPER-CODE & JS: Run, Display Output
        - √ IF SUPER-CODE & RUN-URL: Make ajax to run, Display response
        - IF SUPER-CODE-GROUP & IS-RUNNABLE (HTML, JS, & CSS ONLY): Display and Run all

      4. Respect attributes
        - sandbox: runs JS in a sandbox, defaults true
        -

    -->

    <div id="codePanel" class="panel">
      <content id="superCodeGroupContent" select="super-code-group"></content>
      <content id="superCodeContent" select="super-code"></content>
      <paper-fab id="runButton" src="play-icon.svg" title="heart eyes cat"></paper-fab>
    </div>

  </template>

  <script>
    // I needed the opposite function today, so adding here too:
    function htmlEncode(value){
        return String(value)
            .replace(/&quot;/g, '"')
            .replace(/&#39;/g, "'")
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&amp;/g, '&');
    }

  Polymer({
    is: 'super-code-runnable',
    properties: {},

    created: function() {
      console.log(this.localName + '#' + this.id + ' was created');
    },

    ready: function() {
      console.log(this.localName + '#' + this.id + ' has local DOM initialized');
    },

    attached: function() {
      console.log(this.localName + '#' + this.id + ' was attached');
    },

    detached: function() {
      console.log(this.localName + '#' + this.id + ' was detached');
    },

    attributeChanged: function(name, type) {
      console.log(this.localName + '#' + this.id + ' attribute ' + name +
        ' was changed to ' + this.getAttribute(name));
    },

    listeners: {
      'runButton.tap': 'specialTap'
    },

    generateJSOutput: function() {
      let codeOutput = '';
      let codeResult;
      let codeToEval = Polymer.dom(this.$.superCodeContent).getDistributedNodes()[0].innerHTML;


      if (typeof this.getAttribute('sandbox-js') === 'string' && this.getAttribute('sandbox-js').toLowerCase() === 'false') {
        let _log = console.log;
        let _warn = console.warn;
        let _error = console.error;

        console.log = function() {
          var args = Array.prototype.slice.call(arguments);
          codeOutput += '<div class="console-output">' + args.join(' ') + '</div>';
        };
        console.warn = function() {
          var args = Array.prototype.slice.call(arguments);
          codeOutput += '<div class="console-output level-warn">[warn] ' + args.join(' ') + '</div></br>';
        };
        console.error = function() {
          var args = Array.prototype.slice.call(arguments);
          codeOutput += '<div class="console-output level-error">[error] ' + args.join(' ') + '</div></br>';
        };

        codeResult = eval(codeToEval);

        console.log = _log;
        console.warn = _warn;
        console.error = _error;
      } else {
        let sandboxIFrame = document.createElement('iframe');
        this.appendChild(sandboxIFrame);

        let _log = sandboxIFrame.contentWindow.console.log;
        let _warn = sandboxIFrame.contentWindow.console.warn;
        let _error = sandboxIFrame.contentWindow.console.error;

        sandboxIFrame.contentWindow.console.log = function() {
          var args = Array.prototype.slice.call(arguments);
          codeOutput += '<div class="console-output">' + args.join(' ') + '</div>';
        };
        sandboxIFrame.contentWindow.console.warn = function() {
          var args = Array.prototype.slice.call(arguments);
          codeOutput += '<div class="console-output level-warn">[warn] ' + args.join(' ') + '</div>';
        };
        sandboxIFrame.contentWindow.console.error = function() {
          var args = Array.prototype.slice.call(arguments);
          codeOutput += '<div class="console-output level-error">[error] ' + args.join(' ') + '</div>';
        };

        codeResult = sandboxIFrame.contentWindow.eval(codeToEval);

        sandboxIFrame.contentWindow.console.log = _log;
        sandboxIFrame.contentWindow.console.warn = _warn;
        sandboxIFrame.contentWindow.console.error = _error;
      }


      let displayPanelEl = document.createElement('div');
      displayPanelEl.id = 'displayPanel';
      displayPanelEl.className = 'panel console';
      displayPanelEl.style.height = this.clientHeight + 'px';
      displayPanelEl.innerHTML = codeOutput;

      if (this.getAttribute('display-result')) {
        displayPanelEl.innerHTML += '<div class="console-result"><span style="font-size: .7em; font-weight: bold;">></span> ' + codeResult + '</div>';
      }

      this.root.appendChild(displayPanelEl);

      setTimeout(() => {
        displayPanelEl.scrollTo( 0, 999999 );
      }, 1);
    },

    generateGroupOutput: function() {
      let codeElement = Polymer.dom(this.$.superCodeGroupContent).getDistributedNodes()[0];
      let codeGrouped = {};
      for (panel of codeElement._panels) {
        codeGrouped[panel.getAttribute('language')] = codeGrouped[panel.getAttribute('language')] || [];
        codeGrouped[panel.getAttribute('language')].push(panel.code);
      }
      let htmlToDisplay = '<html><head><style>' + codeGrouped.css.join(' ') + '</style><head><body>' + codeGrouped.html.join(' ') + '<script>' + codeGrouped.js.join(' ') + '\<\/script\></body></html>';

      let displayPanelIFrame = document.createElement('iframe');
      displayPanelIFrame.id = 'displayPanel';
      displayPanelIFrame.className = 'panel';
      displayPanelIFrame.height = this.clientHeight;
      this.root.appendChild(displayPanelIFrame);

      displayPanelIFrame.contentWindow.document.open();
      displayPanelIFrame.contentWindow.document.write(htmlToDisplay);
      displayPanelIFrame.contentWindow.document.close();
    },

    generateHTMLOutput: function() {
      let codeElement = Polymer.dom(this.$.superCodeContent).getDistributedNodes()[0];
      let htmlToDisplay = codeElement.code;

      let displayPanelIFrame = document.createElement('iframe');
      displayPanelIFrame.id = 'displayPanel';
      displayPanelIFrame.className = 'panel';
      displayPanelIFrame.height = this.clientHeight;
      this.root.appendChild(displayPanelIFrame);

      displayPanelIFrame.contentWindow.document.open();
      displayPanelIFrame.contentWindow.document.write(htmlToDisplay);
      displayPanelIFrame.contentWindow.document.close();
    },

    generateSpecialOutput: function() {
      let displayPanelEl = document.createElement('div');
      displayPanelEl.id = 'displayPanel';
      displayPanelEl.className = 'panel console';
      displayPanelEl.style.height = this.clientHeight + 'px';
      displayPanelEl.textContent = 'Loading...';
      this.root.appendChild(displayPanelEl);

      let xhr = new XMLHttpRequest();
      let codeElement = Polymer.dom(this.$.superCodeContent).getDistributedNodes()[0];
      let codeToRun = codeElement.innerHTML || codeElement.getAttribute('code');
      xhr.open('POST', this.getAttribute('run-remote'), true);

      xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {

          if (xhr.status < 400 && xhr.responseText) {
            displayPanelEl.textContent = xhr.responseText;
          }
          else if (xhr.status >= 400) {
            code.textContent = '✖ Error ' + xhr.status + ' while running file: ' + xhr.statusText;
          }
          else {
            code.textContent = '✖ Error: File does not exist or is empty';
          }
        }
      };

      xhr.send(codeToRun);
    },

    specialTap: function(e) {
      let singleEl = Polymer.dom(this.$.superCodeContent).getDistributedNodes()[0];
      let groupEl = Polymer.dom(this.$.superCodeGroupContent).getDistributedNodes()[0];

      if (groupEl) {
        this.generateGroupOutput();
      } else {
        let language = singleEl.getAttribute('language');
        if (language === "js" || language === "javascript") {
          this.generateJSOutput();
        } else if (language === "html") {
          this.generateHTMLOutput();
        } else if (this.getAttribute('run-remote')) {
          this.generateSpecialOutput();
        }
      }

      setTimeout(() => {
        this.toggleClass('activated', true);
      }, 0);
    },

  });
  </script>
</dom-module>
